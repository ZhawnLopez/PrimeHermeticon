<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard — HermetiCart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">

    <style>
    body { background:#0d0f14; font-family:'DM Sans',sans-serif; }
    h1,h2,h3,h4 { font-family:'Cormorant Garamond',serif; }

    .dash-wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.5rem 2rem 5rem;
    }

    .dash-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(201,168,76,0.15);
    }

    .dash-title {
        font-family: 'Cormorant Garamond', serif;
        font-size: 2rem;
        font-weight: 700;
        color: #f0ead6;
    }

    .dash-subtitle {
        font-size: 0.75rem;
        color: #8a8fa8;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        margin-top: 0.2rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2.5rem;
    }

    .stat-card {
        background: #13161e;
        border: 1px solid rgba(201,168,76,0.12);
        border-radius: 16px;
        padding: 1.5rem 1.75rem;
        position: relative;
        overflow: hidden;
        transition: border-color 0.3s;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(201,168,76,0.4), transparent);
    }

    .stat-card:hover { border-color: rgba(201,168,76,0.25); }

    .stat-label {
        font-size: 0.68rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: #8a8fa8;
        margin-bottom: 0.6rem;
    }

    .stat-value {
        font-family: 'Cormorant Garamond', serif;
        font-size: 2.2rem;
        font-weight: 700;
        color: #f0ead6;
        line-height: 1;
    }

    .stat-value span {
        font-size: 1rem;
        color: #c9a84c;
        font-family: 'DM Sans', sans-serif;
        font-weight: 400;
    }

    .tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid rgba(201,168,76,0.15);
        margin-bottom: 2rem;
    }

    .tab-btn {
        background: none;
        border: none;
        color: #8a8fa8;
        font-family: 'DM Sans', sans-serif;
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: color 0.2s, border-color 0.2s;
    }

    .tab-btn:hover { color: #f0ead6; }
    .tab-btn.active { color: #c9a84c; border-bottom-color: #c9a84c; }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        font-size: 0.65rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: #8a8fa8;
        font-family: 'DM Sans', sans-serif;
        font-weight: 400;
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(201,168,76,0.1);
        white-space: nowrap;
    }

    .data-table td {
        padding: 1rem;
        font-size: 0.85rem;
        color: #c8c8d4;
        border-bottom: 1px solid rgba(255,255,255,0.04);
        vertical-align: middle;
        font-family: 'DM Sans', sans-serif;
    }

    .data-table tr:hover td { background: rgba(201,168,76,0.03); }

    .data-table tbody tr:last-child td { border-bottom: none; }

    .table-wrap {
        background: #13161e;
        border: 1px solid rgba(201,168,76,0.12);
        border-radius: 16px;
        overflow: hidden;
    }

    .badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 20px;
        font-size: 0.68rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 500;
    }

    .badge-admin     { background:rgba(201,168,76,0.15); color:#c9a84c; border:1px solid rgba(201,168,76,0.3); }
    .badge-customer  { background:rgba(255,255,255,0.05); color:#8a8fa8; border:1px solid rgba(255,255,255,0.08); }
    .badge-completed { background:rgba(90,158,122,0.15); color:#5a9e7a; border:1px solid rgba(90,158,122,0.3); }
    .badge-pending   { background:rgba(201,168,76,0.1); color:#c9a84c; border:1px solid rgba(201,168,76,0.2); }
    .badge-cancelled { background:rgba(192,69,74,0.12); color:#c0454a; border:1px solid rgba(192,69,74,0.25); }

    .prod-thumb {
        width: 44px; height: 44px;
        background: #0d0f14;
        border-radius: 8px;
        object-fit: contain;
        padding: 4px;
        border: 1px solid rgba(201,168,76,0.1);
    }

    .table-search {
        background: #0d0f14;
        border: 1px solid rgba(201,168,76,0.15);
        border-radius: 8px;
        padding: 0.55rem 1rem;
        color: #f0ead6;
        font-family: 'DM Sans', sans-serif;
        font-size: 0.82rem;
        outline: none;
        width: 240px;
        transition: border-color 0.2s;
        margin-bottom: 1rem;
    }

    .table-search:focus { border-color: rgba(201,168,76,0.4); }
    .table-search::placeholder { color: #3a3f52; }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #8a8fa8;
        font-size: 0.82rem;
        letter-spacing: 0.08em;
    }

    .spinner-sm {
        width: 20px; height: 20px;
        border: 2px solid rgba(201,168,76,0.15);
        border-top-color: #c9a84c;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 0.5rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="navbar"></div>

<div class="dash-wrap">

    <div class="dash-header">
        <div>
            <p style="font-size:0.68rem; letter-spacing:0.18em; text-transform:uppercase; color:#c9a84c; font-family:'DM Sans',sans-serif; margin-bottom:0.3rem;">Admin</p>
            <h1 class="dash-title">Dashboard</h1>
            <p class="dash-subtitle" id="dashGreeting">Loading...</p>
        </div>
        <a href="main.html" style="font-size:0.75rem; letter-spacing:0.1em; text-transform:uppercase; color:#8a8fa8; text-decoration:none; font-family:'DM Sans',sans-serif; transition:color 0.2s;" onmouseover="this.style.color='#c9a84c'" onmouseout="this.style.color='#8a8fa8'">← Back to Store</a>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <p class="stat-label">Total Products</p>
            <p class="stat-value" id="statProducts"><span class="spinner-sm"></span></p>
        </div>
        <div class="stat-card">
            <p class="stat-label">Registered Users</p>
            <p class="stat-value" id="statUsers"><span class="spinner-sm"></span></p>
        </div>
        <div class="stat-card">
            <p class="stat-label">Total Orders</p>
            <p class="stat-value" id="statOrders"><span class="spinner-sm"></span></p>
        </div>
        <div class="stat-card">
            <p class="stat-label">Revenue</p>
            <p class="stat-value" id="statRevenue"><span class="spinner-sm"></span></p>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('products')">Products</button>
        <button class="tab-btn" onclick="switchTab('orders')">Orders</button>
        <button class="tab-btn" onclick="switchTab('users')">Users</button>
    </div>

    <div id="tab-products" class="tab-panel active">
        <input type="text" class="table-search" placeholder="Search products…" oninput="filterTable('productsTable', this.value)">
        <div class="table-wrap">
            <table class="data-table" id="productsTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Stock</th>
                    </tr>
                </thead>
                <tbody id="productsBody">
                    <tr><td colspan="5" class="loading"><span class="spinner-sm"></span>Loading products…</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="tab-orders" class="tab-panel">
        <input type="text" class="table-search" placeholder="Search orders…" oninput="filterTable('ordersTable', this.value)">
        <div class="table-wrap">
            <table class="data-table" id="ordersTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                    <tr><td colspan="7" class="loading"><span class="spinner-sm"></span>Loading orders…</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="tab-users" class="tab-panel">
        <input type="text" class="table-search" placeholder="Search users…" oninput="filterTable('usersTable', this.value)">
        <div class="table-wrap">
            <table class="data-table" id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Joined</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr><td colspan="5" class="loading"><span class="spinner-sm"></span>Loading users…</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="../assets/js/navbar.js"></script>
<script>
async function initDashboard() {
    try {
        const res  = await fetch("../backend/session_status.php", { credentials: 'same-origin' });
        const data = await res.json();

        if (!data.logged) { window.location.href = "login.html"; return; }
        if (data.role !== 'admin') { window.location.href = "main.html"; return; }

        if (typeof applyNavRole === 'function') applyNavRole(data);

        document.getElementById("dashGreeting").textContent =
            `Signed in as ${data.username}`;

        await Promise.all([loadProducts(), loadOrders(), loadUsers()]);

    } catch (err) {
        console.error("Dashboard init error:", err);
        window.location.href = "login.html";
    }
}

function switchTab(name) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    event.target.classList.add('active');
}

function filterTable(tableId, query) {
    const q    = query.toLowerCase();
    const rows = document.querySelectorAll(`#${tableId} tbody tr`);
    rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
}

function fmtDate(str) {
    if (!str) return '—';
    const d = new Date(str);
    return d.toLocaleDateString('en-PH', { year:'numeric', month:'short', day:'numeric' });
}

async function loadProducts() {
    const res      = await fetch("../backend/get_products.php", { credentials:'same-origin' });
    const products = await res.json();

    document.getElementById("statProducts").textContent = products.length;

    const tbody = document.getElementById("productsBody");
    if (products.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="loading">No products found.</td></tr>`;
        return;
    }

    tbody.innerHTML = products.map(p => `
        <tr>
            <td><img src="../${p.image_url}" class="prod-thumb" alt="${p.name}" onerror="this.style.opacity=0.2"></td>
            <td style="color:#f0ead6; font-family:'Cormorant Garamond',serif; font-size:1rem;">${p.name}</td>
            <td style="color:#8a8fa8; font-size:0.78rem;">${p.product_type || '—'}</td>
            <td style="color:#c9a84c; font-weight:500;">₱${parseFloat(p.price).toLocaleString()}</td>
            <td>
                <span style="color:${p.stock_quantity > 0 ? '#5a9e7a' : '#c0454a'}; font-size:0.82rem;">
                    ${p.stock_quantity > 0 ? p.stock_quantity + ' in stock' : 'Out of stock'}
                </span>
            </td>
        </tr>
    `).join('');
}

async function loadOrders() {
    const res    = await fetch("../backend/get_orders.php", { credentials:'same-origin' });
    const orders = await res.json();

    const completed = orders.filter(o => o.status === 'completed');
    const revenue   = completed.reduce((s, o) => s + parseFloat(o.total_amount || 0), 0);

    document.getElementById("statOrders").textContent  = orders.length;
    document.getElementById("statRevenue").innerHTML   =
        `<span style="font-size:1rem; color:#c9a84c;">₱</span>${revenue.toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2})}`;

    const tbody = document.getElementById("ordersBody");
    if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="loading">No orders yet.</td></tr>`;
        return;
    }

    tbody.innerHTML = orders.map(o => `
        <tr>
            <td style="color:#8a8fa8;">#${o.order_id}</td>
            <td style="color:#f0ead6;">${o.username}</td>
            <td style="color:#8a8fa8; font-size:0.78rem;">${o.email}</td>
            <td style="color:#c8c8d4;">${o.item_count} item${o.item_count != 1 ? 's' : ''}</td>
            <td style="color:#c9a84c; font-weight:500;">₱${parseFloat(o.total_amount).toLocaleString()}</td>
            <td><span class="badge badge-${o.status}">${o.status}</span></td>
            <td style="color:#8a8fa8; font-size:0.78rem;">${fmtDate(o.order_date)}</td>
        </tr>
    `).join('');
}

// ── Users ─────────────────────────────────────────────────────────────────────
async function loadUsers() {
    const res   = await fetch("../backend/get_users.php", { credentials:'same-origin' });
    const users = await res.json();

    document.getElementById("statUsers").textContent = users.length;

    const tbody = document.getElementById("usersBody");
    if (users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="loading">No users found.</td></tr>`;
        return;
    }

    tbody.innerHTML = users.map(u => `
        <tr>
            <td style="color:#8a8fa8;">${u.user_id}</td>
            <td style="color:#f0ead6;">${u.username}</td>
            <td style="color:#8a8fa8; font-size:0.78rem;">${u.email}</td>
            <td><span class="badge badge-${u.role}">${u.role}</span></td>
            <td style="color:#8a8fa8; font-size:0.78rem;">${fmtDate(u.created_at)}</td>
        </tr>
    `).join('');
}

async function logout() {
    try {
        await fetch("../backend/logout.php", { method:'POST', credentials:'same-origin' });
    } catch (_) {}
    window.location.href = "login.html";
}

window.logout = logout;

document.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>